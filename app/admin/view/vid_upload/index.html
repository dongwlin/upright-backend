<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Video Upload</title>
    <link rel="stylesheet" href="/static/css/fileUpload.css">
</head>

<body>
<div class="flex items-center justify-center w-full bg-emerald-300 h-12 mb-8 relative">
    <div class="absolute left-0 px-4 hover:bg-emerald-400 h-12 flex justify-center items-center"
         onclick="location.href='/admin'">
        <img
                src="data:image/svg+xml,%3Csvg%20t%3D%221692264327455%22%20class%3D%22icon%22%20viewBox%3D%220%200%201024%201024%22%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20p-id%3D%2212850%22%20width%3D%2232%22%20height%3D%2232%22%3E%3Cpath%20d%3D%22M96%20480c-9.6%200-19.2-3.2-25.6-12.8-12.8-12.8-9.6-35.2%203.2-44.8l377.6-310.4c35.2-25.6%2086.4-25.6%20118.4%200l377.6%20307.2c12.8%209.6%2016%2032%203.2%2044.8-12.8%2012.8-32%2016-44.8%203.2L531.2%20166.4c-9.6-6.4-28.8-6.4-38.4%200L115.2%20473.6c-6.4%206.4-12.8%206.4-19.2%206.4zM816%20928H608c-19.2%200-32-12.8-32-32v-150.4c0-22.4-38.4-44.8-67.2-44.8-28.8%200-64%2019.2-64%2044.8V896c0%2019.2-12.8%2032-32%2032H211.2C163.2%20928%20128%20892.8%20128%20848V544c0-19.2%2012.8-32%2032-32s32%2012.8%2032%2032v304c0%209.6%206.4%2016%2019.2%2016H384v-118.4c0-64%2067.2-108.8%20128-108.8s131.2%2044.8%20131.2%20108.8V864h176c9.6%200%2016%200%2016-19.2V544c0-19.2%2012.8-32%2032-32s32%2012.8%2032%2032v304C896%20896%20864%20928%20816%20928z%22%20fill%3D%22%23ffffff%22%20p-id%3D%2212851%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E"
                alt="home">
    </div>
    <div class="text-lg font-bold text-gray-700">Video Upload</div>
</div>
<div>
    <div id="vidPreBox" class="flex justify-center items-center w-2/3 h-96 mx-auto bg-slate-100 rounded-md p-4">
        <video class="max-h-full" id="vidPre" src="" controls></video>
    </div>
    <div class="w-full flex justify-center">
        <input
                class="w-2/3 p-4 mt-8 rounded-md drop-shadow-sm bg-slate-100 text-base focus:outline-none focus:shadow-md focus:bg-slate-200"
                type="text" name="vidUploadSrc" id="vidUploadSrcInput" placeholder="vid upload src">
    </div>
    <div class="w-full flex justify-center">
        <div id="uploadProgress" class="hidden w-2/3">
            <div id="uploadStatus"></div>
        </div>
    </div>
    <div class="flex justify-center">
        <input class="hidden" type="file" name="video" id="vidInput">
        <label class="block w-48 p-4 m-8 rounded-md text-center bg-teal-400 hover:bg-teal-500 active:bg-teal-300"
               for="vidInput">select video</label>
        <button class="block w-48 p-4 m-8 rounded-md bg-teal-400 hover:bg-teal-500 active:bg-teal-300" id="uploadBtn"
                onclick="handleVidUpload()">upload</button>
        <button class="block w-48 p-4 m-8 rounded-md bg-teal-400 hover:bg-teal-500 active:bg-teal-300"
                onclick="copyVidSrc()">copy url</button>
    </div>
</div>
<script>
    const clearVidPre = () => {
        const vidPre = document.getElementById('vidPre');
        vidPre.src = '';
    }
    const vidInput = document.getElementById('vidInput');
    vidInput.addEventListener('change', event => {
        const selectFile = event.target.files[0];
        if (selectFile.type.startsWith('video/')) {
            const reader = new FileReader();
            const vidBox = document.getElementById('vidPre');
            reader.onload = e => {
                vidBox.src = e.target.result;
            }
            reader.readAsDataURL(selectFile);
        }
        else {
            clearVidPre();
            alert('This type of file is not supported.');
        }
    })

    const handleVidUpload = () => {
        const vidInput = document.getElementById('vidInput');
        if (vidInput.files.length <= 0) {
            alert('No file is selected.');
            return;
        }

        const uploadProgress = document.getElementById("uploadProgress");
        const uploadStatus = document.getElementById("uploadStatus");

        uploadProgress.classList.remove("hidden");
        uploadStatus.textContent = "Uploading...";

        let file = vidInput.files[0];
        const formData = new FormData();
        formData.append('video', file);

        fetch('vid-upload/upload', {
            method: 'POST',
            body: formData
        })
            .then(res => res.json())
            .catch(err => console.error('Error: ' + err))
            .then(res => {
                if (res.code === 201) {
                    const vidUploadSrcInput = document.getElementById('vidUploadSrcInput');
                    uploadStatus.textContent = "Upload completed";
                    vidUploadSrcInput.value = res.data.vidSrc;
                }
                else if (res.code === 400) {
                    uploadStatus.textContent = "Upload failed";
                    alert(res.msg);
                }
                else {
                    uploadStatus.textContent = "Upload failed";
                    console.log(res);
                }
            });
        clearVidPre();
        vidInput.value = '';
    }

    const copyVidSrc = () => {
        const vidUploadSrcInput = document.getElementById('vidUploadSrcInput');
        if (vidUploadSrcInput.value === '') {
            return;
        }
        try {
            navigator.clipboard.writeText(vidUploadSrcInput.value)
                .then(() => {
                    console.log('success.');
                })
                .catch(e => {
                    alert('This feature is available only in secure contexts (HTTPS), in some or all supporting browsers.');
                    console.error('error: ', e);
                });
        }
        catch (e) {
            alert('This feature is available only in secure contexts (HTTPS), in some or all supporting browsers.');
            console.error(e);
        }
    }
</script>
</body>

</html>